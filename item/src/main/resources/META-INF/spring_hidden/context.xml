<?xml version="1.0" encoding="UTF-8"?>

<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:osgi="http://www.eclipse.org/gemini/blueprint/schema/blueprint"
       xmlns:osgi-compendium="http://www.springframework.org/schema/osgi-compendium"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:util="http://www.springframework.org/schema/util"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:schemaLocation="
            http://www.springframework.org/schema/beans              http://www.springframework.org/schema/beans/spring-beans.xsd
            http://www.eclipse.org/gemini/blueprint/schema/blueprint http://www.eclipse.org/gemini/blueprint/schema/blueprint/gemini-blueprint.xsd
            http://www.springframework.org/schema/context            http://www.springframework.org/schema/context/spring-context.xsd
            http://www.springframework.org/schema/osgi-compendium    http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium.xsd
            http://www.springframework.org/schema/util               http://www.springframework.org/schema/util/spring-util-3.1.xsd">

  <!-- Make configuration properties defined in site.properties available -->
  <context:property-placeholder properties-ref="config"/>
  <osgi-compendium:cm-properties id="config" persistent-id="site"/>
  <osgi-compendium:cm-properties id="jpaProperties" persistent-id="jpa"/>

  <!-- OSGi service dependencies -->
  <osgi:reference id="dataSource" interface="javax.sql.DataSource"/>
  <osgi:reference id="jpaDialect" interface="org.springframework.orm.jpa.JpaDialect"/>
  <osgi:reference id="jpaVendorAdapter" interface="org.springframework.orm.jpa.JpaVendorAdapter"/>
  <osgi:reference id="uiService" interface="org.apromore.ui.UIService"/>

  <!-- JPA entity manager factory for the "item" persistence unit -->
  <bean id="entityManagerFactory" class="org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean">
    <property name="dataSource" ref="dataSource"/>
    <property name="persistenceUnitName" value="item" />
    <property name="jpaDialect" ref="jpaDialect"/>
    <property name="jpaVendorAdapter" ref="jpaVendorAdapter"/>
    <property name="jpaProperties" ref="jpaProperties"/>
  </bean>

  <!-- Dynamically maintain a list of the available ItemPlugins -->
  <bean id="itemPluginListener" class="org.apromore.item.impl.ItemPluginListener"/>
  <osgi:list id="itemPlugins" interface="org.apromore.item.spi.ItemPlugin" availability="optional">
    <osgi:reference-listener ref="itemPluginListener" bind-method="onBind" unbind-method="onUnbind"/>
  </osgi:list>

  <!-- Publish the ItemService to clients, and the ItemPluginContext to item providers -->
  <bean id="itemService" class="org.apromore.item.impl.ItemServiceImpl">
    <constructor-arg ref="entityManagerFactory"/>
    <constructor-arg ref="itemPlugins"/>
    <constructor-arg ref="uiService"/>
  </bean>
  <osgi:service ref="itemService" interface="org.apromore.item.spi.ItemPluginContext"/>
  <osgi:service ref="itemService" interface="org.apromore.item.ItemService"/>

</beans>
